import pytest
from aioresponses import aioresponses

from wiz import WizConnectorConfig, WizModule
from wiz.wiz_vulnerability_findings_connector import WizVulnerabilityFindingsConnector


@pytest.fixture
def wiz_vulnerability_findings_connector(
    module: WizModule,
    mock_push_data_to_intakes,
    wiz_gql_client,
) -> WizVulnerabilityFindingsConnector:
    connector = WizVulnerabilityFindingsConnector()
    connector.configuration = WizConnectorConfig(
        intake_key="test_key",
    )

    connector._wiz_gql_client = wiz_gql_client

    connector.module = module

    connector.push_data_to_intakes = mock_push_data_to_intakes

    return connector


@pytest.mark.asyncio
async def test_wiz_vulnerability_findings_connector(
    auth_url,
    tenant_url,
    wiz_vulnerability_findings_connector,
    vulnerability_findings_response_with_next_page,
    vulnerability_findings_response,
    http_token,
):
    with aioresponses() as mocked_responses:
        mocked_responses.post(auth_url, status=200, payload=http_token.dict())
        mocked_responses.post(
            tenant_url + "graphql", status=200, payload={"data": vulnerability_findings_response_with_next_page}
        )
        mocked_responses.post(tenant_url + "graphql", status=200, payload={"data": vulnerability_findings_response})

        result = await wiz_vulnerability_findings_connector.single_run()

        assert result == len(vulnerability_findings_response_with_next_page["vulnerabilityFindings"]["nodes"]) + len(
            vulnerability_findings_response["vulnerabilityFindings"]["nodes"]
        )

        await wiz_vulnerability_findings_connector._wiz_gql_client.close()


@pytest.mark.asyncio
async def test_wiz_vulnerability_findings_connector_with_duplicates(
    auth_url,
    tenant_url,
    wiz_vulnerability_findings_connector,
    vulnerability_findings_response_with_next_page,
    vulnerability_findings_response,
    http_token,
):
    with aioresponses() as mocked_responses:
        mocked_responses.post(auth_url, status=200, payload=http_token.dict())
        mocked_responses.post(
            tenant_url + "graphql", status=200, payload={"data": vulnerability_findings_response_with_next_page}
        )
        mocked_responses.post(
            tenant_url + "graphql", status=200, payload={"data": vulnerability_findings_response_with_next_page}
        )
        mocked_responses.post(tenant_url + "graphql", status=200, payload={"data": vulnerability_findings_response})

        result = await wiz_vulnerability_findings_connector.single_run()

        assert result == len(vulnerability_findings_response_with_next_page["vulnerabilityFindings"]["nodes"]) + len(
            vulnerability_findings_response["vulnerabilityFindings"]["nodes"]
        )

        await wiz_vulnerability_findings_connector._wiz_gql_client.close()
