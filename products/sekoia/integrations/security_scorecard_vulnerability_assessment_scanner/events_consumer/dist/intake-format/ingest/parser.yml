name: vulnerability_assessment_scanner
pipeline:
  - name: parsed_event
    external:
      name: json.parse-json
      properties:
        input_field: "{{original.message}}"
        output_field: message

  - name: parse_date
    external:
      name: date.parse
      properties:
        input_field: "{{parsed_event.message.created_at}}"
        output_field: result

  - name: set_common_fields

stages:
  set_common_fields:
    actions:
      - set:
          "@timestamp": "{{parse_date.result}}"

          event.category: ["vulnerability"]
          event.type: ["info"]
          event.dataset: "issue"
          event.action: "{{parsed_event.message.trigger.type}}"

          observer.vendor: "SecurityScorecard"
          observer.product: "Vulnerability Assessment Scanner"

          cloud.account.name: "{{parsed_event.message.domain}}"
          organization.name: "{{parsed_event.message.trigger.breach.company_name}}"

          securityscorecard.vas.current_score: "{{parsed_event.message.current.score}}"
          securityscorecard.vas.id: "{{parsed_event.message.scorecard_id}}"
          securityscorecard.vas.previous_score: "{{parsed_event.message.previous.score}}"
          securityscorecard.vas.selected: "{{parsed_event.message.trigger.selected}}"
          securityscorecard.vas.severity: "{{parsed_event.message.trigger.severity}}"
          securityscorecard.vas.type: "{{parsed_event.message.trigger.type}}"

      - set:
          event.kind: "alert"
          event.dataset: "breach"
          event.category: ["intrusion_detection"]
          event.type: ["info"]
          event.reason: "{{parsed_event.message.trigger.breach.description}}"
          securityscorecard.vas.breach.root_cause: "{{parsed_event.message.trigger.breach.root_cause}}"
        filter: "{{parsed_event.message.trigger.type == 'breach_reported'}}"
